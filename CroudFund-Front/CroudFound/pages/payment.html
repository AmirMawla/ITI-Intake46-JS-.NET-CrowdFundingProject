<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalize Your Donation - Crowdfund</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .payment-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            padding: 40px 0;
        }
        @media (max-width: 1024px) {
            .payment-container {
                grid-template-columns: 1fr;
            }
        }
        .payment-summary {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 32px;
        }
        .payment-form-card {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 32px;
        }
        .campaign-summary-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .guarantee-card {
            background-color: rgba(0, 124, 255, 0.1);
            border: 1px solid rgba(0, 124, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .card-input-group {
            position: relative;
        }
        .card-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 20px;
            background: var(--bg-darker);
            border-radius: 4px;
        }
        .security-badges {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }
        .security-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .page-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .page-back-btn:hover {
            background: var(--bg-card-hover);
            border-color: rgba(0, 124, 255, 0.35);
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo">
                    <div class="logo-icon">C</div>
                    <span>Crowdfundly</span>
                </div>
                <div class="nav-links">
                    <a href="../index.html">Explore</a>
                    <a href="campaigns.html">Start a Campaign</a>
                    <a href="#about">About Us</a>
                </div>
                <div class="user-actions">
                    <div class="user-profile"><i class="fas fa-bell"></i></div>
                    <div class="user-profile"><i class="fas fa-user"></i></div>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <div style="margin: 24px 0; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
            <button class="page-back-btn" type="button" onclick="goBackSafely()">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </button>
        </div>

        <h1 style="font-size: 36px; font-weight: 700; margin-bottom: 8px;">Finalize your donation</h1>
        <p style="color: var(--text-secondary); margin-bottom: 32px;">Secure your contribution to impact lives today.</p>

        <div class="payment-container">
            <!-- Left: Donation Summary -->
            <div class="payment-summary">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 24px;">Donation Summary</h2>
                
                <div class="campaign-summary-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">CAMPAIGN</div>
                            <div style="font-weight: 700; margin-bottom: 4px;" id="campaignName">Loading...</div>
                            <div style="font-size: 14px; color: var(--text-secondary);" id="campaignCreator">By Creator</div>
                        </div>
                        <img id="campaignImage" src="" alt="Campaign" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover;">
                    </div>
                    <div style="padding-top: 16px; border-top: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span style="color: var(--text-secondary);">Donation amount</span>
                            <span style="font-weight: 600;" id="donationAmount">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span style="color: var(--text-secondary);">Crowdfundly tip</span>
                            <span style="font-weight: 600;" id="platformTip">$0.00</span>
                        </div>
                        <div style="padding-top: 16px; border-top: 2px solid var(--border-color); margin-top: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 14px; color: var(--text-secondary);">Total due</span>
                                <span style="font-size: 24px; font-weight: 700; color: var(--primary-color);" id="totalDue">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guarantee-card">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; flex-shrink: 0;"><i class="fas fa-check"></i></div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Crowdfundly Guarantee</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Your donation is protected. If anything goes wrong, we'll work to make it right.</div>
                    </div>
                </div>
            </div>

            <!-- Right: Payment Method -->
            <div class="payment-form-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 24px; font-weight: 700;">Payment Method</h2>
                    <div style="display: flex; gap: 8px;">
                        <button style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px;">âˆ’</button>
                        <button style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px;">ðŸ“·</button>
                    </div>
                </div>

                <form id="paymentForm" onsubmit="handlePayment(event)">
                    <div class="form-group">
                        <label class="form-label">Cardholder Name</label>
                        <input type="text" class="form-input" placeholder="John Doe" required id="cardholderName">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Card Number</label>
                        <div class="card-input-group">
                            <input type="text" class="form-input" placeholder="0000 0000 0000 0000" required id="cardNumber" maxlength="19" oninput="formatCardNumber(event)">
                            <div class="card-icon"></div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Expiry Date</label>
                            <input type="text" class="form-input" placeholder="MM/YY" required id="expiryDate" maxlength="5" oninput="formatExpiry(event)">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 4px;">
                                <span>CVV</span>
                                <span style="width: 16px; height: 16px; border-radius: 50%; background: var(--bg-darker); display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: help;">?</span>
                            </label>
                            <input type="text" class="form-input" placeholder="***" required id="cvv" maxlength="4">
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 24px; color: var(--success-color);">
                        <i class="fas fa-lock"></i>
                        <span style="font-size: 14px;">Your payment is encrypted and 100% secure.</span>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 16px;">
                        <i class="fas fa-lock"></i> Complete Payment (<span id="paymentButtonAmount">$0.00</span>)
                    </button>

                    <p style="text-align: center; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                        BY CLICKING "COMPLETE PAYMENT", YOU AGREE TO OUR 
                        <a href="#" style="color: var(--primary-color);">TERMS OF SERVICE</a> AND 
                        <a href="#" style="color: var(--primary-color);">PRIVACY POLICY</a>.
                    </p>

                    <div class="security-badges">
                        <div class="security-badge">
                            <i class="fas fa-shield-alt"></i>
                            <span>PCI-DSS</span>
                        </div>
                        <div class="security-badge">
                            <i class="fas fa-sync-alt"></i>
                            <span>SSL SECURE</span>
                        </div>
                        <div class="security-badge">
                            <i class="fas fa-check"></i>
                            <span>VERIFIED</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/nav.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let campaignId = null;
        let pledgeAmount = 0;
        const PLATFORM_TIP_PERCENTAGE = 0.15; // 15% platform tip
        let isProcessingPayment = false;

        function goBackSafely() {
            // Prefer returning to the previous page; if opened directly, fallback
            if (window.history && window.history.length > 1) {
                window.history.back();
            } else {
                redirectTo('campaigns.html');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Get campaign ID and amount from URL params
            campaignId = getQueryParam('campaignId');
            pledgeAmount = parseFloat(getQueryParam('amount')) || 0;
            
            if (!campaignId || !pledgeAmount) {
                showNotification('Invalid payment parameters', 'error');
                redirectTo('campaigns.html');
                return;
            }
            
            await loadCampaignDetails();
            calculateTotals();
        });

        async function loadCampaignDetails() {
            try {
                // Backend Expected: GET /api/campaigns/:id
                // Returns: Campaign object
                const campaign = await getCampaignById(campaignId);

                const title = campaign?.title || 'Campaign';
                // Backend returns: userName + userId (seen in your network response)
                const creatorName =
                    campaign?.userName ||
                    campaign?.creatorName ||
                    campaign?.ownerName ||
                    'Creator';

                document.getElementById('campaignName').textContent = title;
                document.getElementById('campaignCreator').textContent = `By ${creatorName}`;

                const imgEl = document.getElementById('campaignImage');
                // Always set onerror BEFORE setting src to avoid broken icon flashes
                imgEl.onerror = function () {
                    this.onerror = null;
                    this.src = `https://via.placeholder.com/80x80/141b2d/ffffff?text=${encodeURIComponent((title || 'C').charAt(0).toUpperCase())}`;
                };
                // Set a safe placeholder first (prevents empty/broken image on slow load)
                imgEl.src = `https://via.placeholder.com/80x80/141b2d/ffffff?text=${encodeURIComponent((title || 'C').charAt(0).toUpperCase())}`;

                let campaignImage =
                    campaign?.image ||
                    campaign?.imageUrl ||
                    campaign?.coverImageUrl ||
                    `https://source.unsplash.com/80x80/?campaign&sig=${campaign?.id || campaignId}`;

                // If backend returns a relative path (e.g. "images/campaigns/xx.jpg"), convert to full URL
                if (campaignImage && typeof campaignImage === 'string' && !/^https?:\/\//i.test(campaignImage)) {
                    const base = (typeof API_CONFIG !== 'undefined' && API_CONFIG.BASE_URL) ? API_CONFIG.BASE_URL : '';
                    campaignImage = `${base}/${campaignImage.replace(/^\/+/, '')}`;
                }
                imgEl.src = campaignImage;

                // If creator name is missing but we have an ID, try fetching user (best effort)
                if (creatorName === 'Creator') {
                    const possibleUserId = campaign?.creatorId || campaign?.userId || campaign?.userID;
                    if (possibleUserId) {
                        try {
                            const creator = await getUserById(possibleUserId);
                            const fetchedName = creator?.fullName || creator?.name;
                            if (fetchedName) {
                                document.getElementById('campaignCreator').textContent = `By ${fetchedName}`;
                            }
                        } catch (_) {
                            // ignore - keep fallback
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading campaign:', error);
                // fallback UI
                const imgEl = document.getElementById('campaignImage');
                imgEl.src = `https://via.placeholder.com/80x80/141b2d/ffffff?text=${encodeURIComponent('C')}`;
            }
        }

        function calculateTotals() {
            const tip = pledgeAmount * PLATFORM_TIP_PERCENTAGE;
            const total = pledgeAmount + tip;
            
            document.getElementById('donationAmount').textContent = formatCurrency(pledgeAmount);
            document.getElementById('platformTip').textContent = formatCurrency(tip);
            document.getElementById('totalDue').textContent = formatCurrency(total);
            document.getElementById('paymentButtonAmount').textContent = formatCurrency(total);
        }

        function formatCardNumber(event) {
            let value = event.target.value.replace(/\s/g, '');
            let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
            event.target.value = formatted;
        }

        function formatExpiry(event) {
            let value = event.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            event.target.value = value;
        }

        function showConfirmPaymentModal() {
            const existing = document.getElementById('confirmPaymentModal');
            if (existing) existing.remove();

            const totalText = document.getElementById('paymentButtonAmount')?.textContent ||
                formatCurrency(pledgeAmount + (pledgeAmount * PLATFORM_TIP_PERCENTAGE));
            const campaignTitle = document.getElementById('campaignName')?.textContent || 'this campaign';

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'confirmPaymentModal';
            modalOverlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 11000;
                padding: 20px;
            `;

            modalOverlay.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    border-radius: 16px;
                    max-width: 520px;
                    width: 100%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
                    border: 1px solid var(--border-color);
                    overflow: hidden;
                ">
                    <div style="
                        padding: 20px 24px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        gap: 14px;
                    ">
                        <div style="
                            width: 44px;
                            height: 44px;
                            border-radius: 50%;
                            background: rgba(0, 124, 255, 0.15);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary-color);
                            font-size: 20px;
                        ">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h2 style="font-size: 20px; font-weight: 700; margin: 0 0 4px 0;">Confirm secure payment</h2>
                            <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                                You are about to support <strong>${campaignTitle}</strong>. Please review the total before confirming.
                            </p>
                        </div>
                        <button type="button" onclick="closeConfirmPaymentModal()" style="
                            background: none;
                            border: none;
                            color: var(--text-secondary);
                            font-size: 20px;
                            cursor: pointer;
                            padding: 4px 6px;
                            border-radius: 6px;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='var(--bg-card-hover)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 14px;">Total charge</span>
                            <span style="font-size: 22px; font-weight: 700; color: var(--primary-color);">${totalText}</span>
                        </div>
                        <p style="margin: 0; font-size: 12px; color: var(--text-muted);">
                            This includes your donation and any platform tip. Your card details are encrypted and never stored.
                        </p>
                    </div>
                    <div style="padding: 18px 24px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" onclick="closeConfirmPaymentModal()" style="
                            padding: 10px 18px;
                            border-radius: 999px;
                            border: 1px solid var(--border-color);
                            background: var(--bg-darker);
                            color: var(--text-primary);
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 14px;
                            transition: all 0.15s;
                        " onmouseover="this.style.background='var(--bg-card-hover)'" onmouseout="this.style.background='var(--bg-darker)'">
                            Cancel
                        </button>
                        <button type="button" onclick="performPaymentFromModal()" style="
                            padding: 10px 20px;
                            border-radius: 999px;
                            border: none;
                            background: var(--primary-color);
                            color: #fff;
                            font-weight: 700;
                            cursor: pointer;
                            font-size: 14px;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 8px 20px rgba(0, 124, 255, 0.4);
                            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
                        " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 24px rgba(0,124,255,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(0,124,255,0.4)'">
                            <i class="fas fa-lock"></i>
                            <span>Confirm &amp; pay ${totalText}</span>
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modalOverlay);
        }

        function closeConfirmPaymentModal() {
            const modal = document.getElementById('confirmPaymentModal');
            if (modal) modal.remove();
        }

        async function performPaymentFromModal() {
            if (isProcessingPayment) return;
            isProcessingPayment = true;

            try {
                if (!isAuthenticated()) {
                    closeConfirmPaymentModal();
                    showNotification('Please login to complete payment', 'error');
                    redirectTo('login.html');
                    return;
                }

                // 1) Create a test payment method (Stripe test token)
                // Stripe provides special test tokens like: tok_visa, tok_mastercard, tok_amex, tok_chargeDeclined, etc.
                const testPaymentMethod = await createTestPaymentMethod('tok_visa');
                const paymentMethodId =
                    testPaymentMethod?.PaymentMethodId ||
                    testPaymentMethod?.paymentMethodId ||
                    testPaymentMethod?.id ||
                    'tok_visa';

                // 2) Create pledge for this campaign using that payment method
                // Backend Expected: POST /api/Pledges/Campaign/:campaignId
                // Body: { Amount, PaymentMethodId }
                const pledge = await createPledge(campaignId, {
                    amount: pledgeAmount,
                    paymentMethodId: paymentMethodId
                });

                if (pledge) {
                    closeConfirmPaymentModal();
                    showNotification('Payment successful! Thank you for your donation.', 'success');
                    setTimeout(() => {
                        redirectTo(`campaign-detail.html?id=${campaignId}`);
                    }, 1500);
                } else {
                    closeConfirmPaymentModal();
                    showNotification('Payment failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error processing payment:', error);
                closeConfirmPaymentModal();
                const message =
                    (error && (error.originalMessage || error.message)) ||
                    'Error processing payment. Please try again.';
                // If apiCall attached status/data, show it for easier debugging
                const extra = (error && error.status) ? ` (HTTP ${error.status})` : '';
                showNotification(`${message}${extra}`, 'error');
            } finally {
                isProcessingPayment = false;
            }
        }

        async function handlePayment(event) {
            event.preventDefault();
            // Just open the beautiful confirmation modal; actual payment runs from there
            showConfirmPaymentModal();
        }
    </script>
</body>
</html>

